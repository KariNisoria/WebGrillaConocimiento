@page "/grillas"
@using WebGrillaBlazor.DTOs
@using WebGrillaBlazor.ApiClient
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@inject ApiClientGeneric<GrillaDTO> ApiClient

<h3>Gestion de Grillas</h3>

<div class="row mb-3">
    <div class="col-2">
        @* Cambia el uso de <Button> por el componente específico de la librería *@
        <Button Color="ButtonColor.Success" Size="ButtonSize.Small" @onclick="AddGrilla">+Grilla</Button>
    </div>
</div>

<!-- Grilla de roles -->

<Grid @ref="gridGrilla"
      TItem="GrillaDTO"
      Class="table table-hover table-bordered table-striped"
      DataProvider="GetAllGrillas"
      AllowPaging="true"
      PageSize="5"
      AllowSorting="true"
      AllowRowClick="true"
      OnRowClick="OnRowClick"
      OnRowDoubleClick="OnGrillaDobleClick"
      Responsive="true">
    <GridColumns>
        <GridColumn TItem="GrillaDTO" HeaderText="IdGrilla" PropertyName="IdGrilla" SortKeySelector="item => item.IdGrilla">
            @context.IdGrilla
        </GridColumn>
        <GridColumn TItem="GrillaDTO" HeaderText="Nombre" PropertyName="Nombre" SortKeySelector="item => item.Nombre">
            @context.Nombre
        </GridColumn>
        <GridColumn TItem="GrillaDTO" HeaderText="Descripcion" PropertyName="Descripcion" SortKeySelector="item => item.Descripcion">
            @context.Descripcion
        </GridColumn>
        <GridColumn TItem="GrillaDTO" HeaderText="FechaVigencia" PropertyName="FechaVigencia" SortKeySelector="item => item.FechaVigencia">
            @context.FechaVigencia.ToString("dd-MM-yyyy")
        </GridColumn>
        <GridColumn TItem="GrillaDTO" HeaderText="Estado" PropertyName="Estado" SortKeySelector="item => item.Estado">
            @context.Estado
        </GridColumn>
        <GridColumn TItem="GrillaDTO" HeaderText="Ver Temas">
            <a href="@($"/grillas/{@context.IdGrilla}/temas")" class="btn btn-info btn-sm">Ver temas</a>
        </GridColumn>
    </GridColumns>
</Grid>

<!-- Ficha Edicion Grilla -->
<Modal @ref="_EdicionGrilla" UseStaticBackdrop="true" CloseOnEscape="false" Size="ModalSize.Large" />

@if (currentIdGrilla == 0)
{
    <div class="row">
        <label class="col-1">Grilla Actual:</label>
        <p class="col-6">No seleccionada</p>
    </div>
}
else
{
    <div class="row">
    <label class="col-1">Grilla Actual:</label>
    <p class="col-6">@(selectedGrilla?.Descripcion ?? "Cargando...")</p>
    </div>
}


@code {
    private IEnumerable<GrillaDTO> grillas = default!;
    private int currentIdGrilla = 0;

    private Modal _EdicionGrilla = default!;

    private Grid<GrillaDTO> gridGrilla = default!;

    private GrillaDTO selectedGrilla = new();

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("OnInitializedAsync");

        await base.OnInitializedAsync();

    }

    private async Task<GridDataProviderResult<GrillaDTO>> GetAllGrillas(GridDataProviderRequest<GrillaDTO> request)
    {
        Console.WriteLine("GetAllGrillas");

        if (grillas is null) // pull employees only one time for client-side filtering, sorting, and paging
            grillas = await ApiClient.GetAllAsync(); // call a service or an API to pull the employees

        return await Task.FromResult(request.ApplyTo(grillas));
    }

    //--------------------------------
    // Para la creacion de una grilla
    //--------------------------------

    private async Task AddGrilla()
    {
        try
        {
            var nuevo = CreateGrilla();
            
            // Guardar en la base de datos a través de la API
            var grillaGuardada = await ApiClient.CreateAsync(nuevo);
            
            // Refrescar la lista desde la base de datos
            grillas = null; // Limpiar caché para forzar recarga
            await gridGrilla.RefreshDataAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al agregar grilla: {ex.Message}");
            // Aquí podrías mostrar un mensaje de error al usuario
        }
    }

    private GrillaDTO CreateGrilla()
    {
        // No asignar ID manualmente, dejar que la base de datos lo genere
        var nuevo = new GrillaDTO();
        
        nuevo.IdGrilla = 0; // La base de datos asignará el ID
        nuevo.Nombre = $"Nueva Grilla {DateTime.Now:yyyyMMdd-HHmmss}";
        nuevo.Descripcion = $"Descripcion de nueva grilla";
        nuevo.FechaVigencia = DateTime.Today;
        nuevo.Estado = 1; // inactiva

        return nuevo;
    }

    //-------------------------------
    // Para la edicion de una grilla
    //-------------------------------

    private async Task OnGrillaDobleClick(GridRowEventArgs<GrillaDTO> args)
    {
        Console.WriteLine("Evento OnGrillaClick");
        var param = new Dictionary<string, object>();
        param.Add("OnClickCallback", EventCallback.Factory.Create<MouseEventArgs>(this, OnCloseModalEdicionGrilla));
        param.Add("grilla", args.Item);
        // Especifico el tipo del componente que quiero mostrar en el modal
        await _EdicionGrilla.ShowAsync<FichaGrilla>(title: "Edicion Grilla", parameters: param);
    }

    private async Task OnCloseModalEdicionGrilla()
    {
        Console.WriteLine("OnCloseModalEdicionGrilla()");
        await _EdicionGrilla.HideAsync(); // Ocultar el formulario de Edicion
        await RefreshGrid(); // Refrescar la grilla

    }

    private async Task RefreshGrid()
    {
        grillas = null; // Limpiar la caché local de grillas
        await gridGrilla.RefreshDataAsync();
        StateHasChanged(); // Forzar la actualización de la grilla
    }

    //-------------------
    // Prueba de Onclick
    //-------------------

    private async Task OnRowClick(GridRowEventArgs<GrillaDTO> args)
    {
        Console.WriteLine($"OnRowClick Grilla current: {currentIdGrilla} nuevo: {args.Item.IdGrilla} ");
        currentIdGrilla = args.Item.IdGrilla;
        
        try
        {
            selectedGrilla = await ApiClient.GetByIdAsync(currentIdGrilla);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al obtener grilla {currentIdGrilla}: {ex.Message}");
            selectedGrilla = new GrillaDTO { Descripcion = "Error al cargar" };
        }
        
        StateHasChanged(); // Forzar actualización de la UI
    }
}
